<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ó–∞–ø–∏—Å—å –∫ —Å—Ç–æ–º–∞—Ç–æ–ª–æ–≥—É</title>
    <style>
        /* –°—Ç–∏–ª–∏ —Ç–µ –∂–µ —Å–∞–º—ã–µ */
        body{font-family:-apple-system,BlinkMacSystemFont,Roboto,Helvetica,Arial,sans-serif;background-color:var(--tg-theme-bg-color,#fff);color:var(--tg-theme-text-color,#000);padding:20px;box-sizing:border-box;margin:0}
        .logo-container{display:flex;justify-content:center;margin-bottom:15px}.logo{width:100px;height:100px;object-fit:cover;border-radius:50%}
        .header{text-align:center;margin-bottom:20px}
        .services-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px}
        .service-card{background:var(--tg-theme-secondary-bg-color,#f5f5f5);border-radius:12px;padding:15px;text-align:center;border:2px solid transparent;cursor:pointer}
        .service-card.selected{border-color:#2cab37;background:rgba(44,171,55,0.1)}
        input,select,textarea{width:100%;padding:12px;margin-bottom:15px;border:1px solid #ccc;border-radius:8px;box-sizing:border-box;background:var(--tg-theme-bg-color,#fff);color:var(--tg-theme-text-color,#000);-webkit-appearance:none}
    </style>
</head>
<body>

    <div class="logo-container"><img src="https://cdn-icons-png.flaticon.com/512/3004/3004458.png" class="logo"></div>
    <div class="header"><h1>–ó–∞–ø–∏—Å—å –Ω–∞ –ø—Ä–∏–µ–º</h1></div>

    <!-- –£–°–õ–£–ì–ò -->
    <div class="services-grid">
        <div class="service-card" onclick="selectService('–û—Å–º–æ—Ç—Ä', 0)">ü©∫ –û—Å–º–æ—Ç—Ä<br><small>–ë–µ—Å–ø–ª–∞—Ç–Ω–æ</small></div>
        <div class="service-card" onclick="selectService('–õ–µ—á–µ–Ω–∏–µ', 3000)">ü¶∑ –õ–µ—á–µ–Ω–∏–µ<br><small>–æ—Ç 3000‚ÇΩ</small></div>
        <div class="service-card" onclick="selectService('–ß–∏—Å—Ç–∫–∞', 5000)">‚ú® –ß–∏—Å—Ç–∫–∞<br><small>5000‚ÇΩ</small></div>
    </div>

    <label>–î–∞—Ç–∞:</label>
    <input type="date" id="date-input">

    <label>–í—Ä–µ–º—è:</label>
    <select id="time-select"><option value="" disabled selected>-- –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É --</option></select>

    <label>–¢–µ–ª–µ—Ñ–æ–Ω:</label>
    <input type="tel" id="phone-input" placeholder="+7 (999) ...">

    <!-- üî• –ü–û–î–ö–õ–Æ–ß–ê–ï–ú FIREBASE (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –í –¢–ê–ö–û–ú –ü–û–†–Ø–î–ö–ï) -->
    <script type="module">
        // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ –æ–±–ª–∞–∫–∞ Google
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, get, set, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // ===========================================================
        // üëá –í–°–¢–ê–í–¨ –°–Æ–î–ê –î–ê–ù–ù–´–ï –ò–ó –®–ê–ì–ê 2 (Firebase Console) üëá
        // ===========================================================
        const firebaseConfig = {
		  apiKey: "AIzaSyA3m_8K5eQlA9j1MnCWTWUZ_uPHXc6JoA4",
		  authDomain: "stomatolog-booking.firebaseapp.com",
		  databaseURL: "https://stomatolog-booking-default-rtdb.firebaseio.com",
		  projectId: "stomatolog-booking",
		  storageBucket: "stomatolog-booking.firebasestorage.app",
		  messagingSenderId: "402776344296",
		  appId: "1:402776344296:web:b4091ba62458b3c8792b5d"
        };
        // ===========================================================

        // –ó–∞–ø—É—Å–∫–∞–µ–º Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- –õ–û–ì–ò–ö–ê –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ---
        let tg = window.Telegram.WebApp;
        tg.expand();

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤—Ä–µ–º–µ–Ω–∏
        const startHour = 9; 
        const endHour = 20;

        // 1. –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ó–ê–ì–†–£–ó–ö–ê –í–†–ï–ú–ï–ù–ò –ò–ó –û–ë–õ–ê–ö–ê
        async function loadTimeSlots() {
            let dateVal = document.getElementById('date-input').value;
            let select = document.getElementById('time-select');
            
            if (!dateVal) return;

            select.innerHTML = '<option>‚è≥ –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–∑—É...</option>';
            select.disabled = true;

            // –§–æ—Ä–º–∏—Ä—É–µ–º –ø—É—Ç—å –≤ –±–∞–∑–µ: bookings/2023-11-25
            const dateRef = ref(db, 'bookings/' + dateVal);

            try {
                // –°–∫–∞—á–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                const snapshot = await get(dateRef);
                let bookedTimes = [];
                
                if (snapshot.exists()) {
                    // –ï—Å–ª–∏ –∑–∞–ø–∏—Å–∏ –µ—Å—Ç—å, —Å–æ–±–∏—Ä–∞–µ–º –∑–∞–Ω—è—Ç–æ–µ –≤—Ä–µ–º—è
                    // snapshot.val() –≤–µ—Ä–Ω–µ—Ç –æ–±—ä–µ–∫—Ç: { "10:00": {...}, "12:00": {...} }
                    bookedTimes = Object.keys(snapshot.val());
                }

                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫
                select.innerHTML = '<option value="" disabled selected>-- –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è --</option>';
                
                for (let h = startHour; h < endHour; h++) {
                    for (let m of ["00", "30"]) {
                        let timeStr = `${h < 10 ? '0'+h : h}:${m}`;
                        
                        // –ï—Å–ª–∏ –≤—Ä–µ–º—è –∑–∞–Ω—è—Ç–æ –≤ –±–∞–∑–µ - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –µ–≥–æ!
                        if (bookedTimes.includes(timeStr)) continue;

                        let opt = document.createElement("option");
                        opt.value = timeStr;
                        opt.text = timeStr;
                        select.appendChild(opt);
                    }
                }

            } catch (error) {
                alert("–û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: " + error.message);
            } finally {
                select.disabled = false;
            }
        }

        // 2. –§–£–ù–ö–¶–ò–Ø –ó–ê–ü–ò–°–ò (–°–û–•–†–ê–ù–ï–ù–ò–ï –í –û–ë–õ–ê–ö–û)
        window.saveBooking = function() {
            let date = document.getElementById('date-input').value;
            let time = document.getElementById('time-select').value;
            let phone = document.getElementById('phone-input').value;
            let service = selectedService;
            
            tg.MainButton.showProgress();

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É –ø–æ –ø—É—Ç–∏: bookings/–î–ê–¢–ê/–í–†–ï–ú–Ø
            set(ref(db, 'bookings/' + date + '/' + time), {
                phone: phone,
                service: service,
                name: tg.initDataUnsafe.user ? tg.initDataUnsafe.user.first_name : "–ì–æ—Å—Ç—å"
            })
            .then(() => {
                // –ï—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏–ª–æ—Å—å
                tg.MainButton.hideProgress();
                let data = { date, time, phone, service };
                tg.sendData(JSON.stringify(data)); // –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ
            })
            .catch((error) => {
                tg.MainButton.hideProgress();
                alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø–∏—Å–∞—Ç—å—Å—è: " + error.message);
            });
        }

        // --- –°–õ–£–®–ê–¢–ï–õ–ò –°–û–ë–´–¢–ò–ô ---
        document.getElementById('date-input').addEventListener('change', loadTimeSlots);
        
        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–π –¥–∞—Ç—ã
        let today = new Date().toISOString().split('T')[0];
        document.getElementById('date-input').setAttribute('min', today);

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ HTML (–∏–∑-–∑–∞ type="module")
        let selectedService = null;
        window.selectService = function(n, p) {
            selectedService = n;
            document.querySelectorAll('.service-card').forEach(c => c.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            checkForm();
        }

        document.getElementById('time-select').addEventListener('change', checkForm);
        document.getElementById('phone-input').addEventListener('input', checkForm);

        function checkForm() {
            let d = document.getElementById('date-input').value;
            let t = document.getElementById('time-select').value;
            let p = document.getElementById('phone-input').value;
            if (selectedService && d && t && p.length > 5) {
                tg.MainButton.text = `–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ ${t}`;
                tg.MainButton.show();
            } else { tg.MainButton.hide(); }
        }

        Telegram.WebApp.onEvent('mainButtonClicked', window.saveBooking);
    </script>
</body>
</html>