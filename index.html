<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ó–∞–ø–∏—Å—å –∫ —Å—Ç–æ–º–∞—Ç–æ–ª–æ–≥—É</title>
    <style>
        /* --- –°–¢–ò–õ–ò --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        /* –õ–æ–≥–æ—Ç–∏–ø */
        .logo-container { display: flex; justify-content: center; margin-bottom: 15px; }
        .logo { width: 100px; height: 100px; object-fit: cover; border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

        .header { text-align: center; margin-bottom: 25px; }
        .header h1 { font-size: 22px; margin-bottom: 5px; margin-top: 0; }
        .header p { color: var(--tg-theme-hint-color, #888); margin: 0; font-size: 14px; }

        /* –£—Å–ª—É–≥–∏ */
        .services-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        
        /* –ê–Ω–∏–º–∞—Ü–∏—è "–ü—Ä—ã–∂–æ–∫" –¥–ª—è –∏–∫–æ–Ω–∫–∏ */
        @keyframes pop-icon {
            0% { transform: scale(1); }
            50% { transform: scale(1.35); }
            100% { transform: scale(1.15); }
        }

        .service-card {
            background-color: var(--tg-theme-secondary-bg-color, #f5f5f5);
            border: 2px solid transparent; border-radius: 12px; padding: 15px;
            cursor: pointer; text-align: center; transition: all 0.2s ease;
        }
        .service-card .icon { font-size: 32px; display: block; margin-bottom: 10px; }
        .service-card .title { font-weight: bold; font-size: 14px; display: block; }
        .service-card .price { font-size: 12px; opacity: 0.8; }

        /* –°—Ç–∏–ª—å –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏ */
        .service-card.selected {
            border-color: var(--tg-theme-button-color, #2481cc);
            background-color: rgba(36, 129, 204, 0.1);
            box-shadow: 0 4px 15px rgba(36, 129, 204, 0.2);
        }
        .service-card.selected .icon {
            display: inline-block;
            animation: pop-icon 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        /* –ü–æ–ª—è –≤–≤–æ–¥–∞ */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px; }
        
        input, textarea, select {
            width: 100%; padding: 12px; box-sizing: border-box;
            border: 1px solid var(--tg-theme-hint-color, #ccc);
            border-radius: 8px; background-color: var(--tg-theme-bg-color, #fff);
            color: var(--tg-theme-text-color, #000);
            font-size: 16px; outline: none;
            -webkit-appearance: none; appearance: none; /* –£–±–∏—Ä–∞–µ–º —Å—Ç—Ä–µ–ª–∫—É –Ω–∞ iOS */
        }
        input:focus, select:focus, textarea:focus { border-color: var(--tg-theme-button-color, #2481cc); }

    </style>
</head>
<body>

    <!-- –õ–û–ì–û–¢–ò–ü -->
    <div class="logo-container">
        <img src="https://cdn-icons-png.flaticon.com/512/3004/3004458.png" alt="–õ–æ–≥–æ" class="logo">
    </div>

    <div class="header">
        <h1 id="greeting">–ü—Ä–∏–≤–µ—Ç! üëã</h1>
        <p>–ó–∞–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –ø—Ä–∏–µ–º</p>
    </div>

    <!-- –£–°–õ–£–ì–ò -->
    <h3>1. –í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É:</h3>
    <div class="services-grid">
        <div class="service-card" onclick="selectService('consultation', 0)">
            <span class="icon">ü©∫</span><span class="title">–û—Å–º–æ—Ç—Ä</span><span class="price">–ë–µ—Å–ø–ª–∞—Ç–Ω–æ</span>
        </div>
        <div class="service-card" onclick="selectService('caries', 3000)">
            <span class="icon">ü¶∑</span><span class="title">–õ–µ—á–µ–Ω–∏–µ</span><span class="price">–æ—Ç 3000‚ÇΩ</span>
        </div>
        <div class="service-card" onclick="selectService('cleaning', 5000)">
            <span class="icon">‚ú®</span><span class="title">–ß–∏—Å—Ç–∫–∞</span><span class="price">5000‚ÇΩ</span>
        </div>
        <div class="service-card" onclick="selectService('whitening', 10000)">
            <span class="icon">üíé</span><span class="title">–û—Ç–±–µ–ª–∏—Ç—å</span><span class="price">10000‚ÇΩ</span>
        </div>
    </div>

    <!-- –î–ê–¢–ê -->
    <h3>2. –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è:</h3>
    <div class="form-group">
        <label>–î–∞—Ç–∞ –ø—Ä–∏–µ–º–∞:</label>
        <input type="date" id="date-input">
    </div>

    <!-- –í–†–ï–ú–Ø (–ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —Å —Å–µ—Ä–≤–µ—Ä–∞) -->
    <div class="form-group">
        <label>–î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–ª–æ—Ç—ã:</label>
        <select id="time-select">
            <option value="" disabled selected>-- –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É --</option>
        </select>
    </div>

    <!-- –ö–û–ù–¢–ê–ö–¢–´ -->
    <h3>3. –í–∞—à–∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã:</h3>
    <div class="form-group">
        <label>–í–∞—à —Ç–µ–ª–µ—Ñ–æ–Ω:</label>
        <input type="tel" id="phone-input" placeholder="+7 (999) ... " maxlength="18">
    </div>
    
    <div class="form-group">
        <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</label>
        <textarea id="comment-input" rows="2" placeholder="–ß—Ç–æ –±–µ—Å–ø–æ–∫–æ–∏—Ç?"></textarea>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        // ==========================================
        // üëá –í–û–¢ –ó–î–ï–°–¨ –¢–í–û–Ø –°–°–´–õ–ö–ê –ù–ê NGROK üëá
        // ==========================================
        const API_URL = "https://pottier-sena-glaucomatous.ngrok-free.dev";
        // ==========================================

        let tg = window.Telegram.WebApp;
        tg.expand();

        let selectedService = null;
        let selectedPrice = 0;
        let user_name = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.first_name : "–ì–æ—Å—Ç—å";
        document.getElementById("greeting").innerText = `–ü—Ä–∏–≤–µ—Ç, ${user_name}! üëã`;

        tg.MainButton.textColor = "#FFFFFF";
        tg.MainButton.color = "#2cab37";

        // --- 1. –í–´–ë–û–† –£–°–õ–£–ì–ò ---
        function selectService(serviceName, price) {
            selectedService = serviceName;
            selectedPrice = price;
            document.querySelectorAll('.service-card').forEach(c => c.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            checkForm();
        }

        // --- 2. –ó–ê–©–ò–¢–ê –î–ê–¢–´ (–ü–†–û–®–õ–û–ï + –í–´–•–û–î–ù–´–ï) ---
        let now = new Date();
        let todayStr = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
        let dateInputEl = document.getElementById("date-input");
        dateInputEl.setAttribute("min", todayStr);

        dateInputEl.addEventListener('change', function() {
            let val = this.value;
            if (!val) return;

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—Ä–æ—à–ª–æ–µ
            if (val < todayStr) {
                tg.showPopup({message: '–ù–µ–ª—å–∑—è –≤–µ—Ä–Ω—É—Ç—å—Å—è –≤ –ø—Ä–æ—à–ª–æ–µ! üï∞Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ –∞–∫—Ç—É–∞–ª—å–Ω—É—é –¥–∞—Ç—É.'});
                this.value = '';
                return;
            }

            // –ï—Å–ª–∏ –¥–∞—Ç–∞ –æ–∫ - –≥—Ä—É–∑–∏–º –≤—Ä–µ–º—è —Å —Å–µ—Ä–≤–µ—Ä–∞
            updateTimeSlots();
            checkForm();
        });


        // --- 3. –ó–ê–ì–†–£–ó–ö–ê –í–†–ï–ú–ï–ù–ò –° –°–ï–†–í–ï–†–ê (NGROK) ---
        async function updateTimeSlots() {
            let select = document.getElementById('time-select');
            let dateValue = document.getElementById('date-input').value;
            
            select.innerHTML = '<option value="" disabled selected>‚è≥ –ò—â–µ–º —Å–≤–æ–±–æ–¥–Ω–æ–µ –≤—Ä–µ–º—è...</option>';
            select.disabled = true;

            if (!dateValue) return;

            try {
                // –ó–ê–ü–†–û–° –ö –°–ï–†–í–ï–†–£
// –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ ngrok-skip-browser-warning
                let response = await fetch(`${API_URL}/slots?date=${dateValue}`, {
                    method: 'GET',
                    headers: {
                        "ngrok-skip-browser-warning": "true" 
                    }
                });
                
                if (!response.ok) throw new Error("–°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç");
                
                let data = await response.json(); // { slots: ["10:00", "11:00"] }
                let slots = data.slots;

                select.innerHTML = '<option value="" disabled selected>-- –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è --</option>';

                // –§–∏–ª—å—Ç—Ä "—Å–µ–≥–æ–¥–Ω—è" (—É–±–∏—Ä–∞–µ–º –ø—Ä–æ—à–µ–¥—à–∏–µ —á–∞—Å—ã)
                let isToday = (dateValue === todayStr);
                let currentHour = new Date().getHours();
                let currentMinutes = new Date().getMinutes();

                if (slots.length === 0) {
                    let opt = document.createElement("option");
                    opt.text = "–ù–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å –º–µ—Å—Ç –Ω–µ—Ç üòî";
                    select.appendChild(opt);
                } else {
                    slots.forEach(timeStr => {
                        if (isToday) {
                            let [h, m] = timeStr.split(':').map(Number);
                            if (h < currentHour) return;
                            if (h === currentHour && m < currentMinutes) return;
                        }
                        let option = document.createElement("option");
                        option.value = timeStr;
                        option.text = timeStr;
                        select.appendChild(option);
                    });
                }

            } catch (error) {
                alert("–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏: " + error.message);
                select.innerHTML = '<option>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>';
            } finally {
                select.disabled = false;
            }
        }


        // --- 4. –ú–ê–°–ö–ê –¢–ï–õ–ï–§–û–ù–ê ---
        let phoneInput = document.getElementById('phone-input');
        phoneInput.addEventListener('input', function (e) {
            let input = e.target.value.replace(/\D/g, ''); 
            let formatted = '';
            if (!input) { e.target.value = ''; checkForm(); return; }

            let first = input[0];
            if (['7', '8', '9'].indexOf(first) > -1) {
                if (first === '9') input = '7' + input;
                if (first === '8') input = '7' + input.substring(1);
                formatted = '+7 ';
                if (input.length > 1) formatted += '(' + input.substring(1, 4);
                if (input.length >= 5) formatted += ') ' + input.substring(4, 7);
                if (input.length >= 8) formatted += '-' + input.substring(7, 9);
                if (input.length >= 10) formatted += '-' + input.substring(9, 11);
            } else {
                formatted = '+' + input;
            }
            e.target.value = formatted;
            checkForm();
        });
        
        phoneInput.addEventListener('keydown', function(e) {
            if (e.key === 'Backspace' && e.target.value.length <= 4) {
                e.target.value = ''; checkForm();
            }
        });


        // --- 5. –ü–†–û–í–ï–†–ö–ê –§–û–†–ú–´ ---
        document.getElementById('time-select').addEventListener('change', checkForm);

        function checkForm() {
            let date = document.getElementById('date-input').value;
            let time = document.getElementById('time-select').value;
            let phone = document.getElementById('phone-input').value;
            let raw_phone = phone.replace(/\D/g, '');

            if (selectedService && date && time && raw_phone.length >= 11) {
                tg.MainButton.text = `–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ ${time}`;
                tg.MainButton.show();
            } else {
                tg.MainButton.hide();
            }
        }

        // --- 6. –û–¢–ü–†–ê–í–ö–ê ---
        Telegram.WebApp.onEvent('mainButtonClicked', function(){
            let data = {
                type: 'booking',
                service: selectedService,
                price: selectedPrice,
                date: document.getElementById('date-input').value,
                time: document.getElementById('time-select').value,
                phone: document.getElementById('phone-input').value,
                comment: document.getElementById('comment-input').value,
                user_name: user_name
            };
            tg.sendData(JSON.stringify(data));
        });

    </script>
</body>
</html>