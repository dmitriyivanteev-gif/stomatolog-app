<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ó–∞–ø–∏—Å—å –∫ —Å—Ç–æ–º–∞—Ç–æ–ª–æ–≥—É</title>
    <style>
        body{font-family:-apple-system,BlinkMacSystemFont,Roboto,Helvetica,Arial,sans-serif;background-color:var(--tg-theme-bg-color,#fff);color:var(--tg-theme-text-color,#000);padding:20px;box-sizing:border-box;margin:0}
        .logo-container{display:flex;justify-content:center;margin-bottom:15px}.logo{width:100px;height:100px;object-fit:cover;border-radius:50%}
        .header{text-align:center;margin-bottom:20px}
        .services-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px}
        .service-card{background:var(--tg-theme-secondary-bg-color,#f5f5f5);border-radius:12px;padding:15px;text-align:center;border:2px solid transparent;cursor:pointer}
        .service-card.selected{border-color:#2cab37;background:rgba(44,171,55,0.1)}
        input,select,textarea{width:100%;padding:12px;margin-bottom:15px;border:1px solid #ccc;border-radius:8px;box-sizing:border-box;background:var(--tg-theme-bg-color,#fff);color:var(--tg-theme-text-color,#000);-webkit-appearance:none}
    </style>
</head>
<body>

    <div class="logo-container"><img src="https://cdn-icons-png.flaticon.com/512/3004/3004458.png" class="logo"></div>
    <div class="header"><h1>–ó–∞–ø–∏—Å—å –Ω–∞ –ø—Ä–∏–µ–º</h1></div>

    <!-- –£–°–õ–£–ì–ò -->
    <div class="services-grid">
        <div class="service-card" onclick="selectService('–û—Å–º–æ—Ç—Ä', 0)">ü©∫ –û—Å–º–æ—Ç—Ä<br><small>–ë–µ—Å–ø–ª–∞—Ç–Ω–æ</small></div>
        <div class="service-card" onclick="selectService('–õ–µ—á–µ–Ω–∏–µ', 3000)">ü¶∑ –õ–µ—á–µ–Ω–∏–µ<br><small>–æ—Ç 3000‚ÇΩ</small></div>
        <div class="service-card" onclick="selectService('–ß–∏—Å—Ç–∫–∞', 5000)">‚ú® –ß–∏—Å—Ç–∫–∞<br><small>5000‚ÇΩ</small></div>
    </div>

    <label>–î–∞—Ç–∞:</label>
    <input type="date" id="date-input">

    <label>–í—Ä–µ–º—è:</label>
    <select id="time-select"><option value="" disabled selected>-- –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É --</option></select>

    <label>–¢–µ–ª–µ—Ñ–æ–Ω:</label>
    <input type="tel" id="phone-input" placeholder="+7 (999) ...">

    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <!-- üî• –°–ö–†–ò–ü–¢ –° FIREBASE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // ===========================================================
        // üëáüëáüëá –í–°–¢–ê–í–¨ –°–Æ–î–ê –°–í–û–ò –ö–õ–Æ–ß–ò –ò–ó –ö–û–ù–°–û–õ–ò FIREBASE üëáüëáüëá
        // ===========================================================
        const firebaseConfig = {
		  apiKey: "AIzaSyA3m_8K5eQlA9j1MnCWTWUZ_uPHXc6JoA4",
		  authDomain: "stomatolog-booking.firebaseapp.com",
		  databaseURL: "https://stomatolog-booking-default-rtdb.firebaseio.com",
		  projectId: "stomatolog-booking",
		  storageBucket: "stomatolog-booking.firebasestorage.app",
		  messagingSenderId: "402776344296",
		  appId: "1:402776344296:web:b4091ba62458b3c8792b5d"
        };
        // ===========================================================

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        let tg = window.Telegram.WebApp;
        tg.expand();

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let selectedService = null;
        let selectedPrice = 0;
        let user_name = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.first_name : "–ì–æ—Å—Ç—å";

        // --- 1. –î–ï–õ–ê–ï–ú –§–£–ù–ö–¶–ò–Æ –í–´–ë–û–†–ê –£–°–õ–£–ì–ò –ì–õ–û–ë–ê–õ–¨–ù–û–ô ---
        window.selectService = function(name, price) {
            selectedService = name;
            selectedPrice = price;
            
            // –í–∏–∑—É–∞–ª—å–Ω–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ
            document.querySelectorAll('.service-card').forEach(c => c.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            
            checkForm();
        }

        // --- 2. –ó–ê–ì–†–£–ó–ö–ê –í–†–ï–ú–ï–ù–ò ---
        async function loadTimeSlots() {
            let dateVal = document.getElementById('date-input').value;
            let select = document.getElementById('time-select');
            
            if (!dateVal) return;

            select.innerHTML = '<option>‚è≥ –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–∑—É...</option>';
            select.disabled = true;

            const startHour = 9; 
            const endHour = 20;
            let bookedTimes = [];

            try {
                // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∑–∞–Ω—è—Ç–æ–µ –≤—Ä–µ–º—è
                const dateRef = ref(db, 'bookings/' + dateVal);
                const snapshot = await get(dateRef);
                
                if (snapshot.exists()) {
                    bookedTimes = Object.keys(snapshot.val());
                }
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:", error);
                alert("–í–Ω–∏–º–∞–Ω–∏–µ! –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–Ω—è—Ç–æ—Å—Ç—å. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–ª—é—á–∏ Firebase.");
            }

            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫
            select.innerHTML = '<option value="" disabled selected>-- –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è --</option>';
            
            // –§–∏–ª—å—Ç—Ä –Ω–∞ "—Å–µ–≥–æ–¥–Ω—è"
            let now = new Date();
            let todayStr = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0') + '-' + String(now.getDate()).padStart(2,'0');
            let isToday = (dateVal === todayStr);
            let currentHour = now.getHours();
            let currentMinutes = now.getMinutes();

            for (let h = startHour; h < endHour; h++) {
                for (let m of ["00", "30"]) {
                    let timeStr = `${h < 10 ? '0'+h : h}:${m}`;
                    
                    // –ï—Å–ª–∏ –∑–∞–Ω—è—Ç–æ - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
                    if (bookedTimes.includes(timeStr)) continue;

                    // –ï—Å–ª–∏ –ø—Ä–æ—à–ª–æ–µ –≤—Ä–µ–º—è —Å–µ–≥–æ–¥–Ω—è - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
                    if (isToday) {
                        let [th, tm] = timeStr.split(':').map(Number);
                        if (th < currentHour) continue;
                        if (th === currentHour && tm < currentMinutes) continue;
                    }

                    let opt = document.createElement("option");
                    opt.value = timeStr;
                    opt.text = timeStr;
                    select.appendChild(opt);
                }
            }
            select.disabled = false;
            checkForm();
        }

        // --- 3. –§–£–ù–ö–¶–ò–Ø –ó–ê–ü–ò–°–ò ---
        window.saveBooking = function() {
            let date = document.getElementById('date-input').value;
            let time = document.getElementById('time-select').value;
            let phone = document.getElementById('phone-input').value;
            let service = selectedService;
            
            if (!service || !date || !time || !phone) return;

            tg.MainButton.showProgress();

            set(ref(db, 'bookings/' + date + '/' + time), {
                phone: phone,
                service: service,
                name: user_name,
                price: selectedPrice
            })
            .then(() => {
                tg.MainButton.hideProgress();
                let data = { date, time, phone, service, price: selectedPrice, user_name };
                tg.sendData(JSON.stringify(data));
            })
            .catch((error) => {
                tg.MainButton.hideProgress();
                alert("–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏: " + error.message);
            });
        }

        // --- –°–õ–£–®–ê–¢–ï–õ–ò ---
        
        // –î–∞—Ç–∞
        let today = new Date().toISOString().split('T')[0];
        document.getElementById('date-input').setAttribute('min', today);
        document.getElementById('date-input').addEventListener('change', loadTimeSlots);
        
        // –¢–µ–ª–µ—Ñ–æ–Ω (–ú–∞—Å–∫–∞)
        document.getElementById('phone-input').addEventListener('input', function(e){ 
            let x=e.target.value.replace(/\D/g,'').match(/(\d{0,1})(\d{0,3})(\d{0,3})(\d{0,2})(\d{0,2})/); 
            e.target.value=!x[2]?x[1]?'+7':'':`+7 (${x[2]})`+(x[3]?` ${x[3]}`:'')+(x[4]?`-${x[4]}`:'')+(x[5]?`-${x[5]}`:''); 
            checkForm(); 
        });

        // –í—Ä–µ–º—è –∏ –æ–±—â–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
        document.getElementById('time-select').addEventListener('change', checkForm);

        function checkForm() {
            let d = document.getElementById('date-input').value;
            let t = document.getElementById('time-select').value;
            let p = document.getElementById('phone-input').value;
            
            if (selectedService && d && t && p.length > 16) {
                tg.MainButton.text = `–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ ${t}`;
                tg.MainButton.show();
            } else { 
                tg.MainButton.hide(); 
            }
        }

        Telegram.WebApp.onEvent('mainButtonClicked', window.saveBooking);

    </script>
</body>
</html>